<html>
  <head>
    <title>Dowstream Impact: Optimism</title>
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="manifest" href="img/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      var baseUrl = function(){
        var baseurl = window.location.origin+window.location.pathname;
        return baseurl;        
      }
      var urlParams = function(){
        const queryString = window.location.search;
        var values = new URLSearchParams(queryString);
        return values;
      }
              
      var start = async function() {
        var values = urlParams();
        var displayMode = urlParams().get('mode'); // 'devs' or 'fees'
        if (!displayMode) {
          displayMode = 'fees';
        }

        async function fetchAndParseCSVToArray(url) {
          try {
              const response = await fetch(url);
              const data = await response.text();
              const lines = data.split('\n');
              return lines.filter(line => line.trim());
          } catch (error) {
              console.error('Error fetching or parsing CSV:', error);
              return []; 
          }
        };
        var rows = await fetchAndParseCSVToArray('https://ccerv1.github.io/downstream_impact/data.csv');
        
        google.charts.load('current', {'packages':['sankey']});
        google.charts.setOnLoadCallback(drawChart);
      
        function drawChart() {
          var colors = ['#a6cee3', '#b2df8a', '#fb9a99', '#fdbf6f',
                        '#cab2d6', '#ffff99', '#1f78b4', '#33a02c'];
          var height = window.innerHeight * 0.7;
          var width = window.innerWidth- 50;
          var options = {
            height: height,
            width: width,
            sankey: {
              node: {
                colors: colors
              },
              link: {
                colorMode: 'gradient',
                colors: colors
              }
            }
          };

          var sankeyElement = document.getElementById('sankey_basic');
          sankeyElement.style.height = height + 'px';
          sankeyElement.style.width = width + 'px';
        
          var data = new google.visualization.DataTable();
          data.addColumn('string', 'Dependency');
          data.addColumn('string', 'Dependent');
          data.addColumn('number', displayMode === 'devs' ? 'Devs' : 'Fees');
          var new_rows = [];
          for(var i = 1; i < rows.length; i++){
              var split_row = rows[i].split(',');
              var value = displayMode === 'devs' ? parseFloat(split_row[2]) : parseFloat(split_row[3]);
              if(split_row[0] && split_row[1] && value > 0){
                  new_rows.push([split_row[0], split_row[1], value]);
              }
          };

          data.addRows(new_rows);
          var chart = new google.visualization.Sankey(document.getElementById('sankey_basic'));
          chart.draw(data, options);
        };
      };
      start();
    </script>
  </head>

  <body style="font-family: PT Serif,sans-serif; background: rgb(255,255,255); background: linear-gradient(-4deg, rgba(255,255,255,1) 0%, rgba(255,255,255,1) 90%, rgba(147,243,231,1) 100%);">
  
    <img src="img/logo.png" style="max-width: 150px; vertical-align:middle; ">
    <h1 style="font-size: 2em;">Downstream Impact</h1>
    <h2>Tracing the impact of repo dependencies on developers and transaction fees</h2>
    <div>
      <a href="#" onclick="document.location=baseUrl() + '?mode=devs';">Show Devs</a>
      <a href="#" onclick="document.location=baseUrl() + '?mode=fees';">Show Fees</a>
    </div>
     
    <div id=title>
      <h2 style="width:49%; display: inline-block;">Dependent</h2>
      <h2 style="width:50%; display: inline-block; text-align: right;">Dependency</h2>
    </div>
    
    <div id="sankey_basic"></div>
    
    <div>
      <h2>What is this?</h2>
      <div>
        <br>
        This is a visual overview of the downstream impact of dependencies on the health of open source ecosystems.
        This is a visualization powered by <a href="https://www.opensource.observer">Open Source Observer</a>.  
        <br>
      </div>
    </div>
  </body>
</html>
